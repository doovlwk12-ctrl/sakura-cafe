(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1565],{1162:function(e,t,r){Promise.resolve().then(r.bind(r,5865))},5865:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return u}});var a=r(7437),o=r(2265),i=r(2198),c=r(3985),n=r(9057),s=r(5151),l=r(9376);function u(){let{items:e,totalItems:t,totalPrice:r,updateQuantity:u,removeFromCart:d,clearCart:m}=(0,i.j)(),{addOrder:g}=function(){let{request:e,loading:t,error:r}=function(e){let[t,r]=(0,o.useState)(!1),[a,i]=(0,o.useState)(null);return{request:async function(t,a){r(!0),i(null);try{let r=await fetch(e+t,{headers:{"Content-Type":"application/json"},...a});if(!r.ok)throw Error("فشل الاتصال بـ API");return await r.json()}catch(e){return i(e.message),null}finally{r(!1)}},loading:t,error:a}}("/api/orders");return{loading:t,error:r,getOrders:()=>e("/"),addOrder:t=>e("/",{method:"POST",body:JSON.stringify(t)}),updateOrder:(t,r)=>e("/".concat(t),{method:"PUT",body:JSON.stringify(r)}),deleteOrder:t=>e("/".concat(t),{method:"DELETE"})}}(),{user:p,isAuthenticated:h}=(0,c.a)(),{t:y,isRTL:f,language:S}=(0,n.Z)(),{isDark:_}=(0,s.F)(),b=(0,l.useRouter)(),[N,j]=(0,o.useState)(!1),[k,x]=(0,o.useState)(!1),E=async()=>{if(!h){b.push("/auth/login");return}try{await g({items:e,total:r,userId:null==p?void 0:p.id}),m(),b.push("/orders")}catch(e){console.error("Error creating order:",e)}},w=async()=>{try{x(!0);let e=localStorage.getItem("user_token"),t=JSON.parse(localStorage.getItem("user_data")||"{}");if(!e||!t){console.warn("User not logged in for discount");return}console.log("Applying discount for user:",t)}catch(e){console.error("Error applying discount:",e)}finally{x(!1)}};return(0,a.jsxs)("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 p-6",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold mb-4",children:y("cart.title")}),0===e.length?(0,a.jsx)("p",{children:y("cart.empty")}):(0,a.jsxs)("div",{children:[(0,a.jsx)("ul",{children:e.map(e=>(0,a.jsxs)("li",{className:"flex justify-between mb-2",children:[(0,a.jsxs)("span",{children:[e.name," x ",e.quantity]}),(0,a.jsxs)("span",{children:[e.price*e.quantity," SAR"]})]},e.id))}),(0,a.jsxs)("div",{className:"mt-4",children:[(0,a.jsxs)("p",{children:[y("cart.totalItems"),": ",t]}),(0,a.jsxs)("p",{children:[y("cart.totalPrice"),": ",r," SAR"]})]}),(0,a.jsxs)("div",{className:"mt-6 flex gap-3",children:[(0,a.jsx)("button",{onClick:w,disabled:k,className:"px-4 py-2 bg-blue-600 text-white rounded disabled:opacity-50",children:y(k?"cart.applyingDiscount":"cart.applyDiscount")}),(0,a.jsx)("button",{onClick:E,className:"px-4 py-2 bg-green-600 text-white rounded",children:y("cart.checkout")})]})]})]})}},2198:function(e,t,r){"use strict";r.d(t,{Z:function(){return n},j:function(){return c}});var a=r(7437),o=r(2265);let i=(0,o.createContext)(void 0),c=()=>{let e=(0,o.useContext)(i);if(!e)throw Error("useCart must be used within a CartProvider");return e},n=e=>{let{children:t}=e,[r,c]=(0,o.useState)([]),[n,s]=(0,o.useState)(!1);(0,o.useEffect)(()=>{(async()=>{try{let e=localStorage.getItem("user_token"),t=JSON.parse(localStorage.getItem("user_data")||"{}");if(e&&t.id){let r=await fetch("/api/cart/items",{headers:{Authorization:"Bearer ".concat(e),"user-id":t.id}});if(r.ok){let e=await r.json();console.log("✅ تم جلب سلة التسوق من قاعدة البيانات:",e);let t=e.items.map(e=>({id:e.product_id,name:e.product_name,arabicName:e.product_arabic_name||e.product_name||"منتج",price:e.price,quantity:e.quantity,image:e.image,category:e.category,customizations:e.customizations}));c(t);let a=JSON.parse(localStorage.getItem("user_data")||"{}");if(a.id==a.id){let t={...a,loyaltyPoints:e.userPoints||0,pointsExpiryDate:e.pointsExpiryDate};localStorage.setItem("user_data",JSON.stringify(t)),console.log("✅ تم تحديث نقاط المكافآت:",e.userPoints)}}else{console.log("⚠️ لم يتم العثور على سلة تسوق في قاعدة البيانات، جاري تحميل من localStorage");let r=localStorage.getItem("sakura_cart");if(r){let a=JSON.parse(r);c(a);try{for(let r of a)await fetch("/api/cart/items",{method:"POST",headers:{Authorization:"Bearer ".concat(e),"user-id":t.id,"Content-Type":"application/json"},body:JSON.stringify({product_id:r.id,product_name:r.name,product_arabic_name:r.arabicName,price:r.price,quantity:r.quantity,image:r.image,category:r.category,customizations:r.customizations})});console.log("✅ تم رفع السلة المحلية إلى قاعدة البيانات")}catch(e){console.error("❌ فشل في رفع السلة المحلية:",e)}}}}else{let e=localStorage.getItem("sakura_cart");e&&c(JSON.parse(e))}}catch(e){console.error("Error loading cart:",e);try{let e=localStorage.getItem("sakura_cart");e&&c(JSON.parse(e))}catch(e){console.error("Error loading cart from localStorage:",e)}}})()},[]),(0,o.useEffect)(()=>{try{localStorage.setItem("sakura_cart",JSON.stringify(r))}catch(e){console.error("Error saving cart to localStorage:",e)}},[r]);let l=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;try{let a=localStorage.getItem("user_token"),o=JSON.parse(localStorage.getItem("user_data")||"{}");if(!a||!o.id){console.log("⚠️ المستخدم غير مسجل دخول، استخدام localStorage");let a=r.findIndex(t=>t.id===e.id&&JSON.stringify(t.customizations)===JSON.stringify(e.customizations));if(-1!==a){let e=[...r];e[a].quantity+=t,c(e)}else{let a={...e,quantity:t,arabicName:e.arabicName||e.name||"منتج"};c([...r,a])}return}let i=await fetch("/api/cart/items",{method:"POST",headers:{Authorization:"Bearer ".concat(a),"user-id":o.id,"Content-Type":"application/json"},body:JSON.stringify({product_id:e.id,product_name:e.name,product_arabic_name:e.arabicName,price:e.price,quantity:t,image:e.image,category:e.category,customizations:e.customizations})});if(i.ok){let e=await i.json();console.log("✅ تم إضافة المنتج إلى سلة التسوق:",e);let t=e.cart.items.map(e=>({id:e.product_id,name:e.product_name,arabicName:e.product_arabic_name||e.product_name||"منتج",price:e.price,quantity:e.quantity,image:e.image,category:e.category,customizations:e.customizations}));c(t),console.log("تم إضافة المنتج إلى سلة التسوق بنجاح")}else{let e=await i.json();console.error("❌ فشل في إضافة المنتج:",e),alert("فشل في إضافة المنتج: ".concat(e.error))}}catch(e){console.error("Error adding to cart:",e),alert("حدث خطأ في إضافة المنتج إلى سلة التسوق")}},u=async e=>{try{let t=localStorage.getItem("user_token"),a=JSON.parse(localStorage.getItem("user_data")||"{}");if(!t||!a.id){console.log("⚠️ المستخدم غير مسجل دخول، استخدام localStorage"),c(r.filter(t=>t.id!==e));return}if(!r.find(t=>t.id===e)){console.error("❌ لم يتم العثور على العنصر في السلة");return}let o=await fetch("/api/cart/items/".concat(e),{method:"DELETE",headers:{Authorization:"Bearer ".concat(t),"user-id":a.id}});if(o.ok){let e=await o.json();console.log("✅ تم حذف المنتج من سلة التسوق:",e);let t=e.cart.items.map(e=>({id:e.product_id,name:e.product_name,arabicName:e.product_arabic_name||e.product_name||"منتج",price:e.price,quantity:e.quantity,image:e.image,category:e.category,customizations:e.customizations}));c(t)}else{let e=await o.json();console.error("❌ فشل في حذف المنتج:",e),alert("فشل في حذف المنتج: ".concat(e.error))}}catch(e){console.error("Error removing from cart:",e),alert("حدث خطأ في حذف المنتج من سلة التسوق")}},d=async(e,t)=>{try{let a=localStorage.getItem("user_token"),o=JSON.parse(localStorage.getItem("user_data")||"{}");if(!a||!o.id){console.log("⚠️ المستخدم غير مسجل دخول، استخدام localStorage"),t<=0?c(r.filter(t=>t.id!==e)):c(r.map(r=>r.id===e?{...r,quantity:t}:r));return}if(!r.find(t=>t.id===e)){console.error("❌ لم يتم العثور على العنصر في السلة");return}let i=await fetch("/api/cart/items/".concat(e),{method:"PUT",headers:{Authorization:"Bearer ".concat(a),"user-id":o.id,"Content-Type":"application/json"},body:JSON.stringify({quantity:t})});if(i.ok){let e=await i.json();console.log("✅ تم تحديث كمية المنتج:",e);let t=e.cart.items.map(e=>({id:e.product_id,name:e.product_name,arabicName:e.product_arabic_name||e.product_name||"منتج",price:e.price,quantity:e.quantity,image:e.image,category:e.category,customizations:e.customizations}));c(t)}else{let e=await i.json();console.error("❌ فشل في تحديث الكمية:",e),alert("فشل في تحديث الكمية: ".concat(e.error))}}catch(e){console.error("Error updating quantity:",e),alert("حدث خطأ في تحديث كمية المنتج")}},m=async()=>{try{let e=localStorage.getItem("user_token"),t=JSON.parse(localStorage.getItem("user_data")||"{}");if(!e||!t.id){alert("الرجاء تسجيل الدخول أولاً");return}let r=await fetch("/api/cart/items",{method:"DELETE",headers:{Authorization:"Bearer ".concat(e),"user-id":t.id}});if(r.ok){let e=await r.json();console.log("✅ تم حذف جميع المنتجات من سلة التسوق:",e),c([])}else{let e=await r.json();console.error("❌ فشل في حذف سلة التسوق:",e),alert("فشل في حذف سلة التسوق: ".concat(e.error))}}catch(e){console.error("Error clearing cart:",e),alert("حدث خطأ في حذف سلة التسوق")}},g=r.reduce((e,t)=>e+t.quantity,0),p=r.reduce((e,t)=>e+t.price*t.quantity,0);return(0,a.jsx)(i.Provider,{value:{items:r,totalItems:g,totalPrice:p,addToCart:l,removeFromCart:u,updateQuantity:d,clearCart:m,isOpen:n,setIsOpen:s},children:t})}},5151:function(e,t,r){"use strict";r.d(t,{F:function(){return c},f:function(){return n}});var a=r(7437),o=r(2265);let i=(0,o.createContext)(void 0),c=()=>{let e=(0,o.useContext)(i);if(!e)throw Error("useTheme must be used within a ThemeProvider");return e},n=e=>{let{children:t}=e,[r,c]=(0,o.useState)(!0),[n,s]=(0,o.useState)(!1);return((0,o.useEffect)(()=>{let e=localStorage.getItem("sakura-theme");window.matchMedia("(prefers-color-scheme: dark)").matches,"light"===e?(c(!1),document.documentElement.classList.remove("dark")):(c(!0),document.documentElement.classList.add("dark")),s(!0)},[]),n)?(0,a.jsx)(i.Provider,{value:{isDark:r,toggleTheme:()=>{let e=!r;c(e),e?(document.documentElement.classList.add("dark"),localStorage.setItem("sakura-theme","dark")):(document.documentElement.classList.remove("dark"),localStorage.setItem("sakura-theme","light"))}},children:t}):(0,a.jsx)("div",{style:{display:"none"},children:t})}},9376:function(e,t,r){"use strict";var a=r(5475);r.o(a,"usePathname")&&r.d(t,{usePathname:function(){return a.usePathname}}),r.o(a,"useRouter")&&r.d(t,{useRouter:function(){return a.useRouter}})}},function(e){e.O(0,[3464,9057,3985,2971,2117,1744],function(){return e(e.s=1162)}),_N_E=e.O()}]);